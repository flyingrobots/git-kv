# Feature Spec: US-6 â€” Epoch Rollover

**User Story:** As an operator, I can create a new epoch to snapshot the database, keeping new clones small and fast.

**Depends On:** Snapshot/export/import; epoch pointer; Parent-Epoch trailers.

## 1. Acceptance Criteria

- An admin command `git kv epoch new --label <name>` exists.
- Running this command creates a new, empty `refs/kv-chunks/<ns>@<new_epoch_label>` ref.
- It updates the `refs/kv-epoch/<ns>` ref to point to the new epoch label.
- New commits generated by `git kv set/mset` will now include an `Epoch: <new_epoch_label>` trailer.
- New chunked values will be stored in the new chunk ref.
- The commit for the epoch change itself will contain a `Parent-Epoch: <old_epoch_label>` trailer to maintain history.
- A fresh clone of the repository can be made much smaller by only fetching the current epoch's refs (e.g., `git clone --branch <current_epoch_ref> ...`).

## 2. Test Plan

- **Success Case:** Run `git kv epoch new --label 2026Q1`. Verify the `kv-epoch` ref is updated and that new commits have the correct `Epoch` trailer.
- **History Traversal:** After a rollover, test the `git kv history <key>` command and ensure it can traverse across the epoch boundary using the `Parent-Epoch` link.
- **Clone Size:** Create a repo with a large amount of data in one epoch. Create a new epoch. Test a partial/shallow clone of only the new epoch and verify its size is significantly smaller.

## 3. Tasks

- [ ] **CLI: `epoch new` command:** Implement the `git kv epoch new` command.
- [ ] **Client: Epoch Pointer:** Implement logic to update the `refs/kv-epoch/<ns>` ref.
- [ ] **Client: Commit Generation:** Modify the commit generation logic to read the current epoch and include the `Epoch` and `Parent-Epoch` trailers as needed.
- [ ] **Client: Chunk Store:** The chunk writer must use the current epoch when creating the `refs/kv-chunks/...` ref.
- [ ] **Client: History Traversal:** The `history` command logic needs to be updated to recognize the `Parent-Epoch` trailer and traverse commit history across epochs.
- [ ] **Testing:** Add an integration test for the epoch rollover process.
- [ ] **Testing:** Add a specific test for the history traversal across epochs.
- [ ] **Documentation:** Document the epoch concept and the `epoch new` command for administrators.
